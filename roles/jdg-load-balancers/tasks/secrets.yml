---
- name: Log into proper cluster
  shell: oc login https://{{stage_openshift_host}}:8443 --token={{stage_openshift_token}} --insecure-skip-tls-verify=true

- name: Switch to proper project
  shell: oc project {{stage_jdg_project}}

- name: Get Stage LB address
  shell: |
    OPEN_CURLY="{"
    external_ip=$(oc get svc/jdg-app-x-site --template="$OPEN_CURLY{range .status.loadBalancer.ingress}}$OPEN_CURLY{.ip}}$OPEN_CURLY{end}}")
    echo "$external_ip"
  register: _stage_lb_ip

- name: Log into proper cluster
  shell: oc login https://{{aws_openshift_host}}:8443 --token={{aws_openshift_token}} --insecure-skip-tls-verify=true

- name: Switch to proper project
  shell: oc project {{aws_jdg_project}}

- name: Get AWS LB address
  shell: |
    OPEN_CURLY="{"
    external_ip=$(oc get svc/jdg-app-x-site --template="$OPEN_CURLY{range .status.loadBalancer.ingress}}$OPEN_CURLY{.ip}}$OPEN_CURLY{end}}")
    echo "$external_ip"
  register: _aws_lb_ip

- name: Log into proper cluster
  shell: oc login https://{{azure_openshift_host}}:8443 --token={{azure_openshift_token}} --insecure-skip-tls-verify=true

- name: Switch to proper project
  shell: oc project {{azure_jdg_project}}

- name: Get Azure LB address
  shell: |
    OPEN_CURLY="{"
    external_ip=$(oc get svc/jdg-app-x-site --template="$OPEN_CURLY{range .status.loadBalancer.ingress}}$OPEN_CURLY{.ip}}$OPEN_CURLY{end}}")
    echo "$external_ip"
  register: _azure_lb_ip

- debug:
    msg: "Stage IP {{ _stage_lb_ip.stdout }}, AWS IP {{ _aws_lb_ip.stdout }}, Azure IP {{ _azure_lb_ip.stdout }}"

- name: Setting secret values for Stage cluster
  set_fact:
    openshift_host: "{{ stage_openshift_host }}"
    openshift_token: "{{ stage_openshift_token }}"
    jdg_project: "{{ stage_jdg_project }}"
    site: "stage"
    external_address: "{{ _stage_lb_ip.stdout }}"
    discovery_string: "{{ _stage_lb_ip.stdout }}[55200],{{ _aws_lb_ip.stdout }}[55200],{{ _azure_lb_ip.stdout }}[55200]"

- debug:
    msg: "State External address {{ external_address }}, discovery string {{ discovery_string }}"

- include: secrets-2.yml

- name: Setting secret values for AWS cluster
  set_fact:
    openshift_host: "{{ aws_openshift_host }}"
    openshift_token: "{{ aws_openshift_token }}"
    jdg_project: "{{ aws_jdg_project }}"
    site: "aws"
    external_address: "{{ _aws_lb_ip.stdout }}"
    discovery_string: "{{ _stage_lb_ip.stdout }}[55200],{{ _aws_lb_ip.stdout }}[55200],{{ _azure_lb_ip.stdout }}[55200]"

- debug:
    msg: "State External address {{ external_address }}, discovery string {{ discovery_string }}"

- include: secrets-2.yml

- name: Setting secret values for Azure cluster
  set_fact:
    openshift_host: "{{ azure_openshift_host }}"
    openshift_token: "{{ azure_openshift_token }}"
    jdg_project: "{{ azure_jdg_project }}"
    site: "azure"
    external_address: "{{ _azure_lb_ip.stdout }}"
    discovery_string: "{{ _stage_lb_ip.stdout }}[55200],{{ _aws_lb_ip.stdout }}[55200],{{ _azure_lb_ip.stdout }}[55200]"

- debug:
    msg: "State External address {{ external_address }}, discovery string {{ discovery_string }}"

- include: secrets-2.yml
